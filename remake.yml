# This file is automatically generated from remake.yml.whisker:
# edit the file there (or the files that it includes).

packages:
  - BBSclim
  - rBBS
  - RPresence
  - rmarkdown
  - knitr
  - markdown

targets:
  all:
    depends:
      - inst/output/lowa/report.html

## Load objects used for all species
  inst/global_opts.csv:
    command: global_opts()

  inst/model_opts.csv:
    command: model_opts(I(psi.test = TRUE), I(gam.test = TRUE))

  bbs:
    command: GetBBS()

  NA_biovars:
    command: data(target_name)

  gam_mods:
    command: GetGamMods()


## Data processing steps
  inst/output/lowa:
    command: CreateSpp(I(alpha = "lowa"))

  lowa_AOU:
    command: GetAOU(I(alpha = "lowa"))

  inst/output/lowa/raw_counts.csv:
    command: GetSppCounts(bbs_raw = bbs, AOU = lowa_AOU, Write = TRUE, path = 'inst/output/lowa')

  lowa_counts:
    command: read.csv("inst/output/lowa/raw_counts.csv")

  inst/output/lowa/no_outlier_counts.csv:
    command: RemoveOutliers(counts = lowa_counts, Write = TRUE, path = 'inst/output/lowa')

  inst/output/lowa/count_buff.csv:
    command: buffer_BBS(I(alpha = "lowa"), bbs = bbs)
    depends:
      - inst/output/lowa/no_outlier_counts.csv

  inst/output/lowa/route_map.pdf:
    command: make_route_plot(I(alpha = "lowa"))
    depends:
      - inst/output/lowa/count_buff.csv
      - inst/output/lowa/raw_counts.csv
      - inst/output/lowa/no_outlier_counts.csv

  inst/output/lowa/route_clim.csv:
    command: GetBioVars(I(alpha = "lowa"))
    depends:
      - NA_biovars
      - inst/output/lowa/count_buff.csv

  inst/output/lowa/pres/pres_in.pao:
    command: write_pao(I(alpha = "lowa"))
    depends:
      - inst/global_opts.csv
      - inst/output/lowa/count_buff.csv
      - inst/output/lowa/route_clim.csv

## Run models
  lowa_pao:
    command: read.pao(f = "inst/output/lowa/pres/pres_in.pao")

  inst/output/lowa/annual_aic.csv:
    command: test_annual(I(alpha = "lowa"), pao = lowa_pao)
    depends:
      - inst/model_opts.csv

  inst/output/lowa/gam_aic.csv:
    command: RunGamMods(I(alpha = "lowa"), pao = lowa_pao)
    depends:
      - inst/model_opts.csv
      - inst/output/lowa/annual_aic.csv

  lowa_gam_covs:
    command: top_covs(I(alpha = "lowa"), mods = gam_mods)
    depends:
      - inst/output/lowa/gam_aic.csv

  lowa_psi_mods:
    command: GetPsiMods(covs = lowa_gam_covs)

  inst/output/lowa/psi_aic.csv:
    command: RunPsiMods(I(alpha = "lowa"), pao = lowa_pao, mods = lowa_psi_mods)
    depends:
      - inst/model_opts.csv
      - inst/output/lowa/annual_aic.csv

  inst/output/lowa/top_mod.out:
    command: gof(I(alpha = "lowa"), mods = lowa_psi_mods, pao = lowa_pao)
    depends:
      - inst/output/lowa/psi_aic.csv
      - inst/model_opts.csv
      - inst/global_opts.csv
      - inst/output/lowa/route_clim.csv
    quiet: TRUE


## Generate indices
  spp_betas:
    command: GetBetas(I(alpha = "lowa"))
    depends:
      - inst/output/lowa/top_mod.out

  inst/output/lowa/occ.csv:
    command: GetOccProb(I(alpha = "lowa"), betas = spp_betas)
    depends:
      - inst/global_opts.csv
      - inst/output/lowa/count_buff.csv

  inst/output/lowa/indices.csv:
    command: GetIndices(I(alpha = "lowa"))
    depends:
      - inst/output/lowa/occ.csv
      - inst/output/lowa/count_buff.csv
      - inst/global_opts.csv

  lowa:
    command: GetSummary(I(alpha = "lowa"))
    depends:
      - inst/output/lowa/count_buff.csv
      - inst/output/lowa/raw_counts.csv
      - inst/output/lowa/no_outlier_counts.csv
      - inst/output/lowa/psi_aic.csv
      - inst/output/lowa/gam_aic.csv
      - inst/output/lowa/annual_aic.csv
      - inst/output/lowa/top_mod.out

## Generate reports
  inst/output/lowa/report.md:
    knitr:
      input: inst/report.Rmd
    depends:
      - spp_summ: lowa
      - R/reports.R
      - inst/output/lowa/occ.csv
      - inst/output/lowa/indices.csv
    cleanup_level: purge
  inst/output/lowa/report.html:
    command: md2html("inst/output/lowa/report.md")
    cleanup_level: purge


